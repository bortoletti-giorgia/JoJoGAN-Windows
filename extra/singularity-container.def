Bootstrap: docker
From: nvidia/cuda:11.1.1-devel-ubuntu18.04

%post

#Post setup, runs inside the image

# Default mount point used in Shef Uni's ShARC cluster
# mkdir /scratch /data /shared /fastdata

# Nvidia driver file mount paths
mkdir /nvlib /nvbin

# Add nvidia driver paths to the environment variables
echo "\n #Nvidia driver paths \n" >> /environment
echo 'export PATH="/nvbin:$PATH"' >> /environment
echo 'export LD_LIBRARY_PATH="/nvlib:$LD_LIBRARY_PATH"' >> /environment

# Add CUDA paths
echo "\n #Cuda paths \n" >> /environment
echo 'export CPATH="/usr/local/cuda/include:$CPATH"' >> /environment
echo 'export PATH="/usr/local/cuda/bin:$PATH"' >> /environment
echo 'export LD_LIBRARY_PATH="/usr/local/cuda/lib64:$LD_LIBRARY_PATH"' >> /environment
echo 'export CUDA_HOME="/usr/local/cuda"' >> /environment

# Packages for Anaconda
apt-get update && apt-get -y upgrade
apt-get -y install \
build-essential \
wget \
bzip2 \
ca-certificates \
libglib2.0-0 \
libxext6 \
libsm6 \
libxrender1 \
git \
unzip
rm -rf /var/lib/apt/lists/*
apt-get clean

# ninja
wget https://github.com/ninja-build/ninja/releases/download/v1.8.2/ninja-linux.zip
unzip ninja-linux.zip -d /usr/local/bin/
update-alternatives --install /usr/bin/ninja ninja /usr/local/bin/ninja 1 --force

# Installing Anaconda 3 
wget -c https://repo.anaconda.com/archive/Anaconda3-2020.02-Linux-x86_64.sh
/bin/bash Anaconda3-2020.02-Linux-x86_64.sh -bfp /usr/local
# Conda configuration of channels from .condarc file
conda config --file /.condarc --add channels defaults
conda config --file /.condarc --add channels conda-forge
conda update conda
# List installed environments
conda list

# Create new Anaconda env for JoJoGAN "jojo"
conda create -y -n jojo python==3.7

activate jojo
#conda install pytorch==1.8.0 torchvision==0.9.0 torchaudio==0.8.0 cudatoolkit=11.1 -c pytorch -c conda-forge -c nvidia
pip install torch==1.7.1+cu110 torchvision==0.8.2+cu110 torchaudio==0.7.2 -f https://download.pytorch.org/whl/torch_stable.html 
pip install cmake
#pip install urllib3==1.26.11
pip install dlib==19.20 tqdm gdown scikit-learn==0.22 scipy lpips opencv-python wandb matplotlib scikit-image pybind11 ninja
conda install -c conda-forge ffmpeg

# conda install -c conda-forge dlib

